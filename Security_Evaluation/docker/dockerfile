# ============================================
# MCP Benchmark Dashboard - Optimized Multi-Stage Dockerfile
# ============================================
# Multi-stage build for minimal image size and faster builds
# Uses uv package manager for faster dependency installation
# Suitable for Google Cloud Platform deployment
# ============================================

# ============================================
# STAGE 1: Builder - Install Dependencies
# ============================================
FROM python:3.13-slim AS builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install uv package manager (much faster than pip)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"
ENV UV_SYSTEM_PYTHON=1

# Copy dependency files first for better layer caching
COPY pyproject.toml ./

# Install dependencies into a virtual environment for clean transfer
RUN uv venv /opt/venv && \
    uv pip install --python /opt/venv/bin/python \
        "fastapi>=0.121.2" \
        "langchain>=0.3.0" \
        "langchain-openai>=1.0.3" \
        "mcp>=1.21.1" \
        "openai>=2.8.0" \
        "pandas>=2.3.3" \
        "pydantic>=2.0.0" \
        "python-dotenv>=1.2.1" \
        "python-multipart>=0.0.9" \
        "requests>=2.32.5" \
        "uvicorn[standard]>=0.38.0" && \
    # Clean up to reduce size
    find /opt/venv -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/venv -type f -name "*.pyc" -delete && \
    find /opt/venv -type f -name "*.pyo" -delete && \
    find /opt/venv -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/venv -type d -name "test" -exec rm -rf {} + 2>/dev/null || true

# ============================================
# STAGE 2: Runtime - Minimal Production Image
# ============================================
FROM python:3.13-slim AS runtime

WORKDIR /app

# Build arguments (can be overridden at build time)
ARG APP_PORT=8000
ARG ENV_NAME=prod
ARG APP_VERSION=1.0.0
ARG LOG_LEVEL=INFO

# Set environment variables
ENV APP_PORT=${APP_PORT}
ENV ENV_NAME=${ENV_NAME}
ENV APP_VERSION=${APP_VERSION}
ENV LOG_LEVEL=${LOG_LEVEL}
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PATH="/opt/venv/bin:$PATH"
ENV PYTHONPATH=/app

# Install only essential runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    nodejs \
    npm \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy virtual environment from builder stage
COPY --from=builder /opt/venv /opt/venv

# Copy application code (only what's needed for runtime)
COPY ./app ./app
COPY ./servers ./servers
COPY ./static ./static
COPY ./main.py ./main.py
COPY ./mcp_config.json ./mcp_config.json
COPY ./Sales_Records.csv ./Sales_Records.csv

# Create necessary directories
RUN mkdir -p /app/data /app/logs

# Create non-root user for security
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /app

# Create entrypoint script for flexible startup
RUN printf '#!/bin/sh\n\
set -e\n\
\n\
PORT="${APP_PORT:-8000}"\n\
LOG="${LOG_LEVEL:-INFO}"\n\
LOG_LOWER=$(echo "${LOG}" | tr "[:upper:]" "[:lower:]")\n\
\n\
echo "========================================"\n\
echo "MCP Benchmark Dashboard"\n\
echo "========================================"\n\
echo "Environment: ${ENV_NAME}"\n\
echo "Version: ${APP_VERSION}"\n\
echo "Port: ${PORT}"\n\
echo "Log Level: ${LOG_LOWER}"\n\
echo "========================================"\n\
\n\
exec uvicorn app.api.routes:app \\\n\
  --host 0.0.0.0 \\\n\
  --port "${PORT}" \\\n\
  --log-level "${LOG_LOWER}"\n' > /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh && \
    chown appuser:appuser /app/entrypoint.sh

# Switch to non-root user
USER appuser

# Expose the application port
EXPOSE ${APP_PORT}

# Health check to ensure container is running properly
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:${APP_PORT}/health || exit 1

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]

# ============================================
# Build Instructions:
# ============================================
#
# Build the image:
#   docker build -f docker/dockerfile -t mcp-dashboard .
#
# Build with custom arguments:
#   docker build -f docker/dockerfile \
#     --build-arg APP_PORT=3000 \
#     --build-arg ENV_NAME=staging \
#     -t mcp-dashboard .
#
# Run locally:
#   docker run -p 8000:8000 --env-file .env mcp-dashboard
#
# Run with custom port:
#   docker run -p 3000:3000 \
#     --env-file .env \
#     -e APP_PORT=3000 \
#     mcp-dashboard
#
# Push to Google Container Registry (GCR):
#   docker tag mcp-dashboard gcr.io/YOUR_PROJECT_ID/mcp-dashboard
#   docker push gcr.io/YOUR_PROJECT_ID/mcp-dashboard
#
# Deploy to Cloud Run:
#   gcloud run deploy mcp-dashboard \
#     --image gcr.io/YOUR_PROJECT_ID/mcp-dashboard \
#     --platform managed \
#     --region us-central1 \
#     --allow-unauthenticated \
#     --set-env-vars APP_PORT=8080,ENV_NAME=prod
#
# Deploy to Cloud Run with secrets:
#   gcloud run deploy mcp-dashboard \
#     --image gcr.io/YOUR_PROJECT_ID/mcp-dashboard \
#     --platform managed \
#     --region us-central1 \
#     --allow-unauthenticated \
#     --update-secrets OPENAI_API_KEY=openai-key:latest
#
# ============================================
# Size Optimization Tips:
# ============================================
# This multi-stage build significantly reduces image size:
# - Builder stage: ~1.5GB (includes build tools)
# - Runtime stage: ~600-800MB (only runtime dependencies)
# - Savings: ~50% reduction compared to single-stage
#
# Further optimizations applied:
# - Removed __pycache__ directories
# - Removed .pyc and .pyo files
# - Removed test directories
# - Cleaned apt cache
# - Used slim Python base image
# ============================================
